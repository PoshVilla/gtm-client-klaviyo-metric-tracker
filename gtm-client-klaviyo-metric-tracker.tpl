___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Klaviyo Metric Tracker",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "Send Klaviyo events from GTM without code. Identify users and include value or custom properties - no custom HTML tags are required.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "LABEL",
    "name": "labelIntro",
    "displayName": "This tag template lets you send custom events to Klaviyo directly from Google Tag Manager—no coding needed. Just choose the event name, identify the user (email or cookie), and add any properties you want to include.\u003cbr\u003e\u003cbr\u003e"
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "Event Name",
    "simpleValueType": true
  },
  {
    "type": "LABEL",
    "name": "labelEventValue",
    "displayName": "If the event is revenue driven, enter a value or custom variable in the field below.\u003cbr\u003e"
  },
  {
    "type": "TEXT",
    "name": "eventValue",
    "displayName": "Event Value",
    "simpleValueType": true
  },
  {
    "type": "LABEL",
    "name": "labelEventProperties",
    "displayName": "\u003cbr\u003eIf you\u0027d like the event to contain additional information in the form of properties, add them below.\u003cbr\u003e\nEnsure that the \"Property Type\" is set for each property, enabling data to be saved in the correct format within Klaviyo.\u003cbr\u003e\n\u003cb\u003eNote:\u003c/b\u003e \u003ci\u003eFor the array type, enter a comma (,) delimited list of values - for example, \"value 1,value2,value 3\".\u003c/i\u003e\u003cbr\u003e\u003cbr\u003e"
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "eventProperties",
    "displayName": "Metric / Event Properties",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Key",
        "name": "propertyKey",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "propertyValue",
        "type": "TEXT"
      },
      {
        "defaultValue": "text",
        "displayName": "Property Type",
        "name": "propertyType",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "text",
            "displayValue": "Text / String"
          },
          {
            "value": "number",
            "displayValue": "Number"
          },
          {
            "value": "array",
            "displayValue": "Array"
          }
        ],
        "macrosInSelect": true
      }
    ]
  },
  {
    "type": "LABEL",
    "name": "labelIdentification",
    "displayName": "\u003cdiv class\u003d\"gtm-zippy-title blg-body blg-comfortable\"\u003e\u003c/div\u003e\u003cb\u003eIdentification\u003c/b\u003e\u003cbr\u003eThe next two fields represent how Klaviyo will identify the website visitor/profile.\u003cbr\u003e\nThe Klaviyo _kx cookie, is set when:\n\u003cli\u003ea user interacts with a Klaviyo-powered email or SMS message, or \n\u003cli\u003ewhen a user subscribes/opts-in through a Klaviyo form, or\u003c/li\u003e\n\u003cli\u003ethe Klaviyo identify command is called elsewhere on your website\u003c/li\u003e\n\u003cbr\u003e"
  },
  {
    "type": "TEXT",
    "name": "echangeId",
    "displayName": "_kx Cookie (Exchange Id)",
    "simpleValueType": true
  },
  {
    "type": "LABEL",
    "name": "labelEmail",
    "displayName": "If the _kx cookie is missing but an email is available, Klaviyo will identify the user using their email.\u003cbr\u003e\u003cbr\u003e"
  },
  {
    "type": "TEXT",
    "name": "email",
    "displayName": "Email Address",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const createQueue = require('createQueue');
const dataLayerPush = createQueue('dataLayer');
const logToConsole = require('logToConsole');

// Setup queue for Klaviyo (_learnq)
const _learnq = createQueue('_learnq');

// Extract GTM Fields
const eventName = data.eventName;
const email = data.email || '';
const exchangeId = data.exchangeId || '';
const eventValue = data.eventValue || '';
const eventParams = data.eventPropertiesGroup || [];
const debug = data.debug === true;

// === Helper: Trim Whitespace ===
function trim(str) {
  var start = 0, end = str.length - 1;
  while (start <= end && isWS(str.charAt(start))) start++;
  while (end >= start && isWS(str.charAt(end))) end--;
  return str.substring(start, end + 1);
}
function isWS(c) {
  return c === ' ' || c === '\n' || c === '\r' || c === '\t';
}

// === Helper: Convert to Integer (no Math) ===
function toInt(value) {
  var num = value * 1;
  if (typeof num === 'number' && num === num) {
    return (num + '').split('.')[0] * 1;
  }
  return 0;
}

// === Helper: Convert to Two Decimal Float ===
function toTwoDecimals(value) {
  var num = value * 1;
  if (typeof num === 'number' && num === num) {
    var scaled = num >= 0 ? num * 100 + 0.5 : num * 100 - 0.5;
    return ((scaled << 0) / 100);
  }
  return 0;
}

// === Helper: Parse Array from Comma List ===
function parseArray(value) {
  var raw = value.split(',');
  var result = [];
  for (var i = 0; i < raw.length; i++) {
    var item = trim(raw[i]);
    if (item !== '') result.push(item);
  }
  return result;
}

// === Build eventProperties ===
var eventProperties = {};

// Include value if valid
if (eventValue !== '' && eventValue !== '0') {
  eventProperties.value = toTwoDecimals(eventValue);
  if (debug) logToConsole('Klaviyo Tracker: value added = ' + eventProperties.value);
}

// Loop through additional properties
for (var i = 0; i < eventParams.length; i++) {
  var key = eventParams[i].propertyKey;
  var val = eventParams[i].propertyValue;
  var type = eventParams[i].propertyType;

  if (key && key !== '') {
    if (type === 'number') {
      eventProperties[key] = toInt(val);
    } else if (type === 'array') {
      eventProperties[key] = parseArray(val);
    } else {
      eventProperties[key] = val;
    }

    if (debug) logToConsole('Klaviyo Tracker: ' + key + ' = ' + eventProperties[key]);
  }
}

// === Identify ===
if (email !== '') {
  _learnq(['identify', { email: email }]);
  if (debug) dataLayerPush({ event: 'Klaviyo Identify', message: 'Identified via email', email: email });
} else if (exchangeId !== '') {
  _learnq(['identify', { '$exchange_id': exchangeId }]);
  if (debug) dataLayerPush({ event: 'Klaviyo Identify', message: 'Identified via $exchange_id', exchangeId: exchangeId });
} else if (debug) {
  dataLayerPush({ event: 'Klaviyo Identify', message: 'No identifier provided' });
}

// === Track ===
if (eventName) {
  _learnq(['track', eventName, eventProperties]);

  if (debug) {
    logToConsole('Klaviyo Tracker: Event sent - ' + eventName);
    dataLayerPush({
      event: 'Klaviyo Event Tracked',
      eventName: eventName,
      properties: eventProperties
    });
  }

  data.gtmOnSuccess();
} else {
  if (debug) logToConsole('Klaviyo Tracker: No event name provided.');
  data.gtmOnFailure('Missing event name.');
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_learnq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Track Event with Name and Email
  code: |
    test('Tracks event with email and value', () => {
      const mockQueue = mock('createQueue');
      const data = {
        eventName: 'Viewed Product',
        email: 'test@example.com',
        eventValue: '49.99',
        eventPropertiesGroup: [],
        debug: false
      };

      runCode(data);

      const calls = mockQueue.calls('_learnq');
      assertThat(calls).hasLength(2);

      assertThat(calls[0]).equals(['identify', { email: 'test@example.com' }]);
      assertThat(calls[1][0]).equals('track');
      assertThat(calls[1][1]).equals('Viewed Product');
      assertThat(calls[1][2].value).equals(49.99);
    });
- name: Track Event when _kx / Exchange Id is Missing
  code: |-
    test('Tracks event using $exchange_id if email is missing', () => {
      const mockQueue = mock('createQueue');
      const data = {
        eventName: 'Downloaded Report',
        email: '',
        exchangeId: 'abc123kx',
        eventValue: '',
        eventPropertiesGroup: [],
        debug: false
      };

      runCode(data);

      const calls = mockQueue.calls('_learnq');
      assertThat(calls[0]).equals(['identify', { '$exchange_id': 'abc123kx' }]);
      assertThat(calls[1][0]).equals('track');
      assertThat(calls[1][1]).equals('Downloaded Report');
    });
- name: Send Properties with Different Types
  code: |-
    test('Tracks event with typed properties', () => {
      const mockQueue = mock('createQueue');
      const data = {
        eventName: 'Started Quiz',
        email: 'quiz@example.com',
        exchangeId: '',
        eventValue: '',
        eventPropertiesGroup: [
          { propertyKey: 'Category', propertyValue: 'Certification', propertyType: 'text' },
          { propertyKey: 'Steps', propertyValue: '5', propertyType: 'number' },
          { propertyKey: 'Tags', propertyValue: 'Finance,B2C,CPA', propertyType: 'array' }
        ],
        debug: false
      };

      runCode(data);

      const calls = mockQueue.calls('_learnq');
      const props = calls[1][2];

      assertThat(props.Category).equals('Certification');
      assertThat(props.Steps).equals(5);
      assertThat(props.Tags).isEqualTo(['Finance', 'B2C', 'CPA']);
    });
- name: Event Name Missing
  code: |-
    test('Fails when eventName is missing', () => {
      const data = {
        eventName: '',
        email: 'fail@example.com',
        exchangeId: 'kx-fallback',
        eventValue: '',
        eventPropertiesGroup: [],
        debug: false
      };

      const fail = failCode(data);
      assertThat(fail).contains('Missing event name');
    });
- name: No Identifiers
  code: |-
    test('Skips identify if no email or exchangeId', () => {
      const mockQueue = mock('createQueue');
      const data = {
        eventName: 'Anonymous Visit',
        email: '',
        exchangeId: '',
        eventValue: '',
        eventPropertiesGroup: [],
        debug: false
      };

      runCode(data);

      const calls = mockQueue.calls('_learnq');
      assertThat(calls).hasLength(1); // Only track, no identify
      assertThat(calls[0][0]).equals('track');
    });
setup: |-
  const createQueue = require('createQueue');
  const dataLayerPush = createQueue('dataLayer');
  const logToConsole = require('logToConsole');


___NOTES___

Created on 07/04/2025, 15:42:24


